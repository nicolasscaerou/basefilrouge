#super wiki: https://wiki.deimos.fr/images/4/45/Secure_bsd_pf.pdf
#https://www.freebsd.org/doc/handbook/firewalls-pf.html
#https://wiki.deimos.fr/Introduction_à_Packet_Filter.html
#https://wiki.deimos.fr/Packet_Filter_:_Lutter_contre_le_bruteforce.html

#====================
#  VARIABLES
#====================

externe="xn0"
interne="lo0"
application="56029"


#====================
#    HYGIENE
#====================

#1 Declaration des ports a ne pas logguer
ports_not_logged = "{ netbios-ssn, microsoft-ds, epmap, ms-sql-s, 5900 }"

#2 normalisation des paquets pour lutter contre les paquets errones
match in all scrub (no-df)

#3 contre attaque Kevin mitnick
antispoof for $externe inet

#4 on ne touche rien a l'interface local
set skip on lo

#5 Par defaut on bloque et on loggue tous les paquets venant de l'extérieur
block in on $externe log all

#6 On n a pas envie de remplir nos logs en 5 min avec les quelques vers connus qui traient sur le net. Donc on bloque certains paquets sans les logger
block in on $externe inet proto tcp from any to any port $ports_not_logged

#7 creation table des IP a bloquer
table <liste_noire> persist

#8 blocage des IP de la blacklist
block drop in quick on $externe from <liste_noire>

#====================
#    EXAMEN
#====================


#=======================
#EXAMEN-contrainte n°1 = API devra etre accessible à distance sur le port de votre choix
rdr pass on $externe proto tcp from any to any port 56022 -> 127.0.0.1 port $application

#=======================
#EXAMEN-contrainte n°2 = La machine devra être accessible par ssh pour sa maintenance, sur le port de votre choix
rdr pass on $externe proto tcp from any to any port 56056 -> 127.0.0.1 port ssh
# + ouverture acces port 56056 sur AWS

#=======================
#EXAMEN-contrainte n°3 = limiter le nombre de requetes par secondes pour les usagers 
# pas plus de 10 connections simultanees,
# pas plus de 3 connections toutes les secondes
# inscription a la liste_noire de l'IP qui ne le respecte pas
pass in on $externe proto { tcp, icmp } to $externe port 22 \
    flags S/SA keep state \
    (max-src-conn 10, max-src-conn-rate 3/1, overload <liste_noire> flush global)


#=======================
# complement
#=======================

# On autorise les pings en provenance de l'extérieur
pass in on $externe inet proto icmp from any to any




# On ne filtre pas les paquets sur l'interface interne
pass quick on $interne

